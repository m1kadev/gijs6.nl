#!/bin/bash

serve() {
  .venv/bin/python engine.py serve
}

build() {
  .venv/bin/python engine.py build
  find build -name '*.css' -exec sh -c 'npx lightningcss --browserslist --bundle --minify "$1" -o "$1"' _ {} \;
  npx prettier --write --ignore-path /dev/null "build/**/*.{css,js,xml,html}"
}

deploy() {
  build
  lift deploy && echo "Deployed successfully to https://$(yq .name Liftfile)"
}

publish() {
  if ! git diff-index --quiet HEAD --; then
    git stash push -m "bake-publish"
    STASHED=1
  else
    STASHED=0
  fi

  format || true
  git commit -a -m "Format repo" || true

  if [ "$STASHED" -eq 1 ]; then
    git stash pop
  fi

  git push & deploy & wait
}

format() {
  ruff format .
  npx prettier --write "**/*.{css,js,json,xml}"
  djlint . --reformat
  markdownlint --fix "**/*.md" || true
}
